'''
Created on Jan 3, 2013

@author: chunwei
'''
import os
from sqlalchemy import  create_engine
from sqlalchemy.orm import sessionmaker
import table_def as db
import common

class RecordReverse:
    def __init__(self, dir='/home/chunwei/NetFlixData/training_set/', dbpath='sqlite:////home/chunwei/swin2/db/database.db'):
        self._dir = dir
        self._dbpath = dbpath
        self.datadic = {}
    
    def setup(self):
        engine = create_engine(self._dbpath, echo=False)
        # create a Session
        Session = sessionmaker(bind=engine)
        self.session = Session()  

    def load(self):
        files = os.listdir(self._dir)
        for f in files:
            path = os.path.join(self._dir, f)
            f = open(path)
            content = f.read()
            yield content
            f.close()

    def parse(self):
        for i,c in enumerate(self.load()):
            movie = 0
            lines = c.split('\n')
            for l in lines:
                if len(l.split(',')) < 3 and common.canfind(l, ':'):
                    '''
                    movie id
                    '''
                    words = l.split(':')
                    movie = int(words[0])
                    assert movie<17779, 'Error: movieid greater than max 17770'
                else:
                    #get user record
                    #parse line
                    words = l.split(',')
                    userid = int(words[0])
                    rank = int(words[1])
                    assert userid < 480190, 'Error: userid greater than max'
                    assert rank <= 5, 'Error: rank greater than max 5'
                    #add record to dic
                    if not self.datadic.has_key(userid):
                        #create new key
                        self.datadic[userid] = []
                    self.datadic[userid].append((movie, rank))
                    
    def output(self, userid, records):
        '''
        records = [(userid, recor)]
        '''
    
